<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
    <style>
        #jwplayerDiv {
            width: 100%;
            max-width: 800px; /* Optional: Set maximum width */
            margin: 0;
        }
    </style>
</head>

<body>
    <div id="jwplayerDiv"></div>

    <script>
        // Function to get URL parameters
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Function to fetch JSON data
        function fetchChannels(callback) {
            var url = 'https://channels-json.deno.dev/';
            fetch(url)
                .then(response => response.json())
                .then(data => callback(data))
                .catch(error => console.error('Error fetching JSON:', error));
        }

        // Define player setup function
        function setupPlayer(channelData) {
            // Set up JWPlayer
            var playerSetup = {
                file: channelData.url,
                position: 'bottom',
                autostart: true,
                stretching: "",
                width: "100%",
                title: channelData.name // Set title from channel data
            };

            // Check if the manifest type is MPEG-DASH
            if (channelData.manifest_type === 'MPEG-DASH|DASH|MPD') {
                // Set up DRM for DASH with keys if available
                playerSetup.type = 'dash';

                // Check if Clear Key is available
                if (channelData.kid && channelData.k) {
                    playerSetup.drm = {
                        widevine: {
                            url: channelData.license_key,
                            headers: {
                                'Content-Type': 'application/octet-stream'
                            },
                            // Convert hex-encoded key to Uint8Array
                            key: Uint8Array.from(atob(channelData.k), c => c.charCodeAt(0))
                        }
                    };
                } else {
                    console.error('Widevine keys not available.');
                }
            } else {
                // Default to HLS without keys
                playerSetup.type = 'hls';
            }

            jwplayer("jwplayerDiv").setup(playerSetup);
        }

        // Fetch channels data and set up the player
        fetchChannels(function(response) {
            // Extract channels data from the response
            var channelsData = response;

            // Get channel name from the URL
            var channelName = getParameterByName('channel');

            // Check if channelsData is an array
            if (Array.isArray(channelsData)) {
                // Find the channel data in the array
                var channelData = channelsData.find(channel => channel.name === channelName);

                if (channelData) {
                    // Set up the player with the channel data
                    setupPlayer(channelData);
                } else {
                    console.error('Channel not found:', channelName);
                }
            } else {
                console.error('Channels data is not an array:', channelsData);
            }
        });

        // Adjust player size on window resize
        window.addEventListener('resize', function() {
            var playerDiv = document.getElementById('jwplayerDiv');
            var playerWidth = playerDiv.offsetWidth; // Get the width of the player div
            var playerHeight = playerWidth * 0.5625; // Calculate height to maintain 16:9 aspect ratio
            jwplayer().resize(playerWidth, playerHeight); // Resize the player
        });
    </script>

    <!-- Cloudflare Web Analytics -->
    <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "69cc198caeb54890bfc3f54a55843365"}'>
    </script>

    <!-- End Cloudflare Web Analytics -->
</body>

</html>
